# è‡ªå‹•ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ (Claude Code)
#
# æ©Ÿèƒ½:
# - PRä½œæˆæ™‚ã«Claude CodeãŒè‡ªå‹•ã§ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼
# - code-reviewã‚¹ã‚­ãƒ«ã‚’ä½¿ç”¨
# - ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœã‚’PRã«ã‚³ãƒ¡ãƒ³ãƒˆ
#
# è¨­å®š:
# - ANTHROPIC_API_KEY ã¾ãŸã¯ ZAI_API_KEY ã‚’è¨­å®š

name: Auto Code Review

on:
  pull_request:
    types: [opened, synchronize, ready_for_review]

jobs:
  claude-review:
    # ãƒ‰ãƒ©ãƒ•ãƒˆPRã¯é™¤å¤–
    if: github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code
        run: npm install -g @anthropic-ai/claude-code
      
      - name: Get changed files
        id: changed
        run: |
          FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E '\.(ts|tsx|js|jsx|py)$' | head -20 | tr '\n' ' ')
          echo "files=$FILES" >> $GITHUB_OUTPUT
      
      - name: Run Claude Code Review
        if: steps.changed.outputs.files != ''
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          # GLM API ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆ
          # ANTHROPIC_API_KEY: ${{ secrets.ZAI_API_KEY }}
          # ANTHROPIC_BASE_URL: ${{ vars.ANTHROPIC_BASE_URL }}
        run: |
          echo "å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ã„ã¾ã™..."
          
          # code-review ã‚¹ã‚­ãƒ«ã‚’ä½¿ç”¨ã—ã¦ãƒ¬ãƒ“ãƒ¥ãƒ¼
          claude --print "ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãã ã•ã„ã€‚å“è³ªã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®è¦³ç‚¹ã§ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„: ${{ steps.changed.outputs.files }}" > review_output.txt 2>&1 || true
          
          # çµæœã‚’ä¿å­˜
          echo "::group::Review Output"
          cat review_output.txt
          echo "::endgroup::"
      
      - name: Comment on PR
        if: steps.changed.outputs.files != ''
        uses: peter-evans/create-or-update-comment@v5
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ## ğŸ¤– Claude Code Review
            
            å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«: `${{ steps.changed.outputs.files }}`
            
            <details>
            <summary>ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœ</summary>
            
            ```
            $(cat review_output.txt | head -100)
            ```
            
            </details>
            
            ---
            *Auto-generated by Claude Code*
      
      - name: No files to review
        if: steps.changed.outputs.files == ''
        run: echo "ãƒ¬ãƒ“ãƒ¥ãƒ¼å¯¾è±¡ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“"
