# Auto Code Review (Claude Code)
#
# Features:
# - Automatically runs Claude Code review on PR creation
# - Uses code-review skill
# - Posts review results as PR comment
#
# Configuration:
# - Set ANTHROPIC_API_KEY or ZAI_API_KEY

name: Auto Code Review

on:
  pull_request:
    types: [opened, synchronize, ready_for_review]

jobs:
  claude-review:
    # Skip draft PRs
    if: github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code
        run: npm install -g @anthropic-ai/claude-code
      
      - name: Get changed files
        id: changed
        run: |
          FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E '\.(ts|tsx|js|jsx|py)$' | head -20 | tr '\n' ' ')
          echo "files=$FILES" >> $GITHUB_OUTPUT
      
      - name: Run Claude Code Review
        if: steps.changed.outputs.files != ''
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          # For GLM API:
          # ANTHROPIC_API_KEY: ${{ secrets.ZAI_API_KEY }}
          # ANTHROPIC_BASE_URL: ${{ vars.ANTHROPIC_BASE_URL }}
        run: |
          echo "Reviewing changed files..."
          
          # Use code-review skill
          claude --print "Review the following files for quality, performance, and security: ${{ steps.changed.outputs.files }}" > review_output.txt 2>&1 || true
          
          echo "::group::Review Output"
          cat review_output.txt
          echo "::endgroup::"
      
      - name: Comment on PR
        if: steps.changed.outputs.files != ''
        uses: peter-evans/create-or-update-comment@v5
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ## ðŸ¤– Claude Code Review
            
            Changed files: `${{ steps.changed.outputs.files }}`
            
            <details>
            <summary>Review Results</summary>
            
            ```
            $(cat review_output.txt | head -100)
            ```
            
            </details>
            
            ---
            *Auto-generated by Claude Code*
      
      - name: No files to review
        if: steps.changed.outputs.files == ''
        run: echo "No files to review"
